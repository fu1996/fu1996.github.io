<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-webpack docs-doc-id-webpack5源码解析/webpack5中的事件调度系统和NormalModuleFactary核心逻辑">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">05-webpack5中的事件调度系统和NormalModuleFactary核心逻辑 | 俊奎</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fu1996.github.io/webpack/webpack5源码解析/webpack5中的事件调度系统和NormalModuleFactary核心逻辑"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-webpack-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-webpack-current"><meta data-rh="true" property="og:title" content="05-webpack5中的事件调度系统和NormalModuleFactary核心逻辑 | 俊奎"><meta data-rh="true" name="description" content="1. 书接上回，从 this.factorizeQueue.add(options, callback); 开始"><meta data-rh="true" property="og:description" content="1. 书接上回，从 this.factorizeQueue.add(options, callback); 开始"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fu1996.github.io/webpack/webpack5源码解析/webpack5中的事件调度系统和NormalModuleFactary核心逻辑"><link data-rh="true" rel="alternate" href="https://fu1996.github.io/webpack/webpack5源码解析/webpack5中的事件调度系统和NormalModuleFactary核心逻辑" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://fu1996.github.io/webpack/webpack5源码解析/webpack5中的事件调度系统和NormalModuleFactary核心逻辑" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="俊奎 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="俊奎 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="俊奎" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.634bf5fc.css">
<link rel="preload" href="/assets/js/runtime~main.526452a3.js" as="script">
<link rel="preload" href="/assets/js/main.9718d5f0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ 如果这个网站能帮助到你，欢迎给一个star支持作者  <a target="_blank" rel="noopener noreferrer" href="https://github.com/fu1996/fu1996.github.io">GitHub</a></div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">俊奎</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" docid="me">我和博客 📝</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/me">大学四年</a></li><li><a class="dropdown__link" href="/blog">博客</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">前端知识库 💡</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/html-css">HTML和CSS</a></li><li><a class="dropdown__link" href="/js">JavaScript</a></li><li><a class="dropdown__link" href="/ts">TypeScript</a></li><li><a class="dropdown__link" href="/react/build-your-react-01">React</a></li><li><a class="dropdown__link" href="/babel">Babel 原理</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/webpack">Webpack 源码</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">后端知识库 📖</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/linux">Linux</a></li><li><a class="dropdown__link" href="/python">Python</a></li><li><a class="dropdown__link" href="/mysql">Mysql</a></li><li><a class="dropdown__link" href="/docker">Docker</a></li><li><a class="dropdown__link" href="/k8s">K8s</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">学习课件 🏫</a><ul class="dropdown__menu"><li><a class="dropdown__link" target="_blank" href="/fe/index.html">前端基础（老）</a></li><li><a class="dropdown__link" target="_blank" href="/py/01day/01_操作系统（科普章节）.html">Python 高级（老）</a></li><li><a class="dropdown__link" target="_blank" href="/flask/index.html">Flask（老）</a></li><li><a class="dropdown__link" target="_blank" href="/django/index.html">Django（老）</a></li><li><a class="dropdown__link" target="_blank" href="/py-mp/index.html">微信开发（老）</a></li><li><a class="dropdown__link" target="_blank" href="/redis/index.html">Redis（老）</a></li><li><a class="dropdown__link" target="_blank" href="/celery/index.html">Celery（老）</a></li><li><a class="dropdown__link" target="_blank" href="/scrapy/index.html">Scrapy（老）</a></li></ul></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/fu1996/fu1996.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><b>俊奎</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/webpack/">webpack5源码解析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/webpack/">01-webpack 打包原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/webpack/webpack5源码解析/02-3000字图文并茂的解析 webpack 核心库 enhanced-resolve 工作流程和插拔式插件机制">02-3000字图文并茂的解析 webpack 核心库 enhanced-resolve 工作流程和插拔式插件机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/webpack/webpack5源码解析/耗时7个小时，用近50张图来学习enhance-resolve中的数据流动和插件调度机制">03-耗时7个小时，用近50张图来学习enhance-resolve中的数据流动和插件调度机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/webpack/webpack5源码解析/浅析webpack5中Compiler中重要的hook调用过程">04-浅析webpack5中Compiler中重要的hook调用过程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/webpack/webpack5源码解析/webpack5中的事件调度系统和NormalModuleFactary核心逻辑">05-webpack5中的事件调度系统和NormalModuleFactary核心逻辑</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/webpack/webpack5源码解析/webpack5的loader-runner源码浅析">06-webpack5的loader-runner源码浅析</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>05-webpack5中的事件调度系统和NormalModuleFactary核心逻辑</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-书接上回从-thisfactorizequeueaddoptions-callback-开始">1. 书接上回，从 <code>this.factorizeQueue.add(options, callback);</code> 开始<a href="#1-书接上回从-thisfactorizequeueaddoptions-callback-开始" class="hash-link" aria-label="1-书接上回从-thisfactorizequeueaddoptions-callback-开始的直接链接" title="1-书接上回从-thisfactorizequeueaddoptions-callback-开始的直接链接">​</a></h2><p>不是很清楚上下文的兄弟，可以去看下我之前写的 <code>（源码篇01）浅析webpack5中Compiler中重要的hook调用过程</code>。</p><blockquote><p>此文比较干，各位读者开始阅读前，请准备好 <code>瓜子，可乐，矿泉水</code>，好好享受阅读源码的乐趣。</p></blockquote><p><img loading="lazy" alt="img" src="/assets/images/1N0ppVKhESQpOu9FLMPmDj0cX4MlDuDO-9fcdbdfb8d7be4ece355337694d8a5cc.gif" width="270" height="270" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-通过-factorizequeue-了解-asyncqueue">1.1 通过 factorizeQueue 了解 AsyncQueue<a href="#11-通过-factorizequeue-了解-asyncqueue" class="hash-link" aria-label="1.1 通过 factorizeQueue 了解 AsyncQueue的直接链接" title="1.1 通过 factorizeQueue 了解 AsyncQueue的直接链接">​</a></h3><p>那么 这个 <code>this.factorizeQueue</code> 指的是什么呢？谁来创建的呢？首先此处的 this 指的是 <code>Compilation</code> 的 实例对象，那就去 <code>Compilation</code> 查找，全局搜索一下 <code>Compilation.js</code> 文件，找到了，代码如下（中文注释是我加的）：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncQueue&lt;Module, Module, Module&gt;} 进程依赖项队列 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">processDependenciesQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;processDependencies&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parallelism</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">parallelism</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_processModuleDependencies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncQueue&lt;Module, string, Module&gt;} 添加模块队列 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">addModuleQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;addModule&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">processDependenciesQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function-variable function" style="color:#d73a49">getKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token parameter">module</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">identifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_addModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncQueue&lt;FactorizeModuleOptions, string, Module | ModuleFactoryResult&gt;} 分解队列 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">factorizeQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;factorize&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">addModuleQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_factorizeModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncQueue&lt;Module, Module, Module&gt;} 构建队列 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">buildQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;build&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">factorizeQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_buildModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncQueue&lt;Module, Module, Module&gt;} 重新构建的队列 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rebuildQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rebuild&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parallelism</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">parallelism</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_rebuildModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>你会发现好家伙，这不仅仅只有一个队列呀，这里是有一堆的队列。但是都是 <code>AsyncQueue</code> 创建的不同名称的实例。 那根据 <code>this.factorizeQueue.add(options, callback);</code> 我们下一步就是去看 <code>AsyncQueue</code> 中的 <code>add</code> 方法了。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-深入-asyncqueue-中的-add-方法">1.2 深入 <code>AsyncQueue</code> 中的 <code>add</code> 方法<a href="#12-深入-asyncqueue-中的-add-方法" class="hash-link" aria-label="12-深入-asyncqueue-中的-add-方法的直接链接" title="12-深入-asyncqueue-中的-add-方法的直接链接">​</a></h3><p>在深入了解 add 之前，我们先要了解 它的 构造函数都需要哪些参数，以便我们更好的理解其内部的工作原理。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> name</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> parallelism</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> parent</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> processor</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> getKey </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_parallelism</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parallelism </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_processor</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> processor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_getKey</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   getKey </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {(T) =&gt; K} */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {any} */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {Map&lt;K, AsyncQueueEntry&lt;T, K, R&gt;&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_entries</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {ArrayQueue&lt;AsyncQueueEntry&lt;T, K, R&gt;&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ArrayQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncQueue&lt;any, any, any&gt;[]} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_willEnsureProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_needProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_stopped</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_root</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parent </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> parent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_root</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hooks</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncSeriesHook&lt;[T]&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">beforeAdd</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;item&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {SyncHook&lt;[T]&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">added</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;item&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {AsyncSeriesHook&lt;[T]&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">beforeStart</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncSeriesHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;item&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {SyncHook&lt;[T]&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">started</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;item&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {SyncHook&lt;[T, Error, R]&gt;} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">result</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SyncHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;item&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;error&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;result&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_ensureProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_ensureProcessing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>入参如下：<code>name, parallelism, parent, processor, getKey</code>。name 字段是绑在实例身上的 <!-- -->_<!-- -->name，<!-- -->_<!-- -->parallelism 先忽略，<code>parent</code> 属性是比较重要的， 有 <code>parent</code>属性的情况下，实例的 <code>this._root</code> 指向的是 父级的 <code>parent._root</code>，否则指向的就是实例本身。并且会把自身丢进 父级的 <code>this._root._children</code> 里。</p><blockquote><p>(另外在此构造函数里的 <code>hooks</code>就是给当前实例绑定一些执行周期的钩子，比较容易扩展，都是老 webpack 玩家了，这里就不过多的介绍了。这里要注意 新建实例的 <code>_willEnsureProcessing</code>,<code>_needProcessing</code>和 <code>_stopped</code> 默认值都是 <code>false</code> 状态。)</p></blockquote><p>分析一下 1.1 中的代码：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">addModuleQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;addModule&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">processDependenciesQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function-variable function" style="color:#d73a49">getKey</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token parameter">module</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> module</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">identifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_addModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">factorizeQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;factorize&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">addModuleQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_factorizeModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">buildQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;build&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">factorizeQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_buildModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>this.addModuleQueue 中的 <!-- -->_<!-- -->root 指向的是 this.processDependenciesQueue.<!-- -->_<!-- -->root，也就是 processDependenciesQueue 自身，</li><li>this.factorizeQueue 中的 <!-- -->_<!-- -->root 指向的是 this.addModuleQueue.<!-- -->_<!-- -->root，而 this.addModuleQueue.<!-- -->_<!-- -->root 指向的是 processDependenciesQueue</li><li>this.buildQueue 中的 <!-- -->_<!-- -->root 指向的是 this.factorizeQueue.<!-- -->_<!-- -->root，而 this.factorizeQueue.<!-- -->_<!-- -->root 指向的是 processDependenciesQueue</li></ol><p>这意味着上面创建的队列中的 父子关系是如下图的：</p><p><img loading="lazy" alt="img" src="/assets/images/c3b2898d-4205-4f13-921b-ff64ba660258-327da443cfcb93eb0821e5cc8f3de6e9.png" width="1846" height="646" class="img_ev3q"></p><p>知道了父子关系以后，就开始看 <code>add</code> 函数具体执行了什么操作，直接断点到这里，看下入参都是什么？（记不着的兄弟去看我前一篇文章。）</p><p><img loading="lazy" alt="img" src="/assets/images/2df65bf2-783e-48d3-8d5a-43710dfdb3f0-c15ed93b8364aabf6c74e2d0799c716c.png" width="2204" height="1594" class="img_ev3q"></p><p>进入 <code>add</code> 函数内部。</p><p><img loading="lazy" alt="img" src="/assets/images/c68f4252-9bf9-4dee-8d11-50a9a4177e5f-b55ea026483d80386de3b99506d3067f.png" width="2052" height="428" class="img_ev3q"></p><p>大致的逻辑就是 判断一下 <code>this._stopped</code> 当前的实例队列是不是暂停的状态，是暂停的状态就 直接 <code>callback</code> 抛出错误。 那核心的步骤就在 <code>this.hooks.beforeAdd.callAsync</code>这个 hook 了，老规矩，debug 这个 hook 看一下有哪些 监听者。</p><p><img loading="lazy" alt="img" src="/assets/images/35bf8117-013b-4951-a8e5-c75157f84958-6fb1ea943bab6ac130b3bf88b7724d66.png" width="1866" height="1690" class="img_ev3q"></p><p>发现这个 hook 没有一个监听者，直接执行了本身的 callback 函数，继续 debug 下去。进入 hook 的内部，</p><p><img loading="lazy" alt="img" src="/assets/images/e6bbfea2-7648-46e2-9540-d968ea643ebb-2a5b65707e10840a07d718544fbfbcac.png" width="2080" height="1560" class="img_ev3q"></p><p>部分没有走到的逻辑 直接跳过，根据 <code>item 和 callback</code> 实例化<code>AsyncQueueEntry</code> 对象，并赋值给 <code>newEntry</code>变量。 稍微看下 <code>AsyncQueueEntry</code> 类。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">QUEUED_STATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PROCESSING_STATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DONE_STATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">AsyncQueueEntry</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  * @param {T} item the item</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  * @param {Callback&lt;R&gt;} callback the callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">item</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {typeof QUEUED_STATE | typeof PROCESSING_STATE | typeof DONE_STATE} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">QUEUED_STATE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {Callback&lt;R&gt;[] | undefined} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">callbacks</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">result</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/** @type {WebpackError | undefined} */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">error</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到对于 AsyncQueueEntry 的<code>this.state</code>字段有 3 个状态可选（看 jsDoc 部分，也就是 <code>this.state</code> 的上一行），初始创建的 实例是 <code>QUEUED_STATE</code> 状态，也就是排队状态。</p><p><img loading="lazy" alt="img" src="/assets/images/ccc0883a-e1cb-4a28-a442-e5b7e1053ce3-67555f9d26f95b23a79e3f0ccc3d86ed.png" width="858" height="418" class="img_ev3q"></p><p>大致知道了 <code>newEntry</code> 变量承载了什么东西，继续 debug 下一步。 <img loading="lazy" alt="img" src="/assets/images/9767d67c-49d0-457f-9541-956451f3bb4e-fdd001af77c25ae928460b8d91daa2b4.png" width="2076" height="1382" class="img_ev3q"></p><p>没有进入 if 语句的 成功分支，走了 else 部分（也就是红色圈中部分）。此处的代码量比较少，但是比较核心。 首先看 148 行 <code>this._queued.enqueue(newEntry);</code> 就是把当前的 <code>newEntry</code> 实例 丢入到 自身的 队列里。 接下来 149 行，找到该实例的父级 也就是 <code>_name</code> 为 <code>processDependencies</code> 的实例。在 150 行 将其父级的 <code>_needProcessing</code> 变更为 true， 因为默认创建的实例的 <code>_willEnsureProcessing</code> 的状态为 false，所以此处会走进 151 行的判断逻辑，去执行 152-154 行的代码，将<code>父级(processDependencies)</code>的 <code>_ensureProcessing</code> 丢进定时器里（注意是父级的，异步函数会在同步函数执行完毕以后调用，另外异步函数也是有优先级之分的哈，不一定是最先丢进去的，最先执行）。 继续 debug, 触发 156 的 hook 钩子。 <img loading="lazy" alt="img" src="/assets/images/a2e5dfb9-38d3-4a78-8181-282cb9b88e3d-af0d409b85e88389a3793946e99b76b1.png" width="1724" height="1468" class="img_ev3q"> 这个钩子真可怜，没有人注册监听事件。（就不放 s 图了，上次放的 s 图导致违规了）。</p><p>至此同步的函数执行完毕了，别忘了之前还向定时器里丢了一个异步的 <code>父级(processDependencies)</code>的 <code>_ensureProcessing</code> 方法，下一步直接断点蹲在 <code>_ensureProcessing</code>处。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-浅浅的总结一下">1.3 浅浅的总结一下~<a href="#13-浅浅的总结一下" class="hash-link" aria-label="1.3 浅浅的总结一下~的直接链接" title="1.3 浅浅的总结一下~的直接链接">​</a></h3><ol><li>webpack 中的 <code>Compilation</code> 实例，创建了 4 个有父子关系的异步队列</li><li>最先开始 工作的是 <code>factorizeQueue</code> 队列，执行了 <code>factorizeQueue</code> 队列的 add 方法。</li><li>在 add 方法中，将 <code>factorizeQueue</code>队列的<code>父级(processDependencies)</code>队列的<code>_ensureProcessing</code> 方法放入了定时器中。</li><li>至此，同步函数执行完毕，开始执行 <code>父级(processDependencies)</code>的 <code>_ensureProcessing</code> 的方法。</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-异步队列要开始了">2. 异步队列要开始了<a href="#2-异步队列要开始了" class="hash-link" aria-label="2. 异步队列要开始了的直接链接" title="2. 异步队列要开始了的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-执行-processdependencies-队列的-_ensureprocessing-方法">2.1 执行 <code>processDependencies</code> 队列的 <code>_ensureProcessing</code> 方法<a href="#21-执行-processdependencies-队列的-_ensureprocessing-方法" class="hash-link" aria-label="21-执行-processdependencies-队列的-_ensureprocessing-方法的直接链接" title="21-执行-processdependencies-队列的-_ensureprocessing-方法的直接链接">​</a></h3><p>直接断点到 <code>_ensureProcessing</code> 方法，验证一下猜想。</p><p><img loading="lazy" alt="img" src="/assets/images/397417c6-1cd2-4808-b28d-4b513ea63ea1-f486195e379ab6703d9a6fead866d88a.png" width="2250" height="1734" class="img_ev3q"></p><p>相关代码贴出来</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">_ensureProcessing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;queue _ensureProcessing&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 100 的并发量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_parallelism</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PROCESSING_STATE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">异步队列名称：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation keyword" style="color:#00009f">this</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation property-access">_name</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string string" style="color:#e3116c">，开始工作了：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token template-string interpolation">entry</span><span class="token template-string interpolation punctuation" style="color:#393A34">.</span><span class="token template-string interpolation property-access">item</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_startProcessing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_willEnsureProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// this._children 是之前创建的 addModule factorize 和  build的 AsyncQueue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// lib/Compilation.js 的 944 行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> child </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_parallelism</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PROCESSING_STATE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_startProcessing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_willEnsureProcessing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_needProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>开始分析流程，this 指向的是 <code>processDependencies</code> 的实例队列，而在上一步是给它的子队列<code>factorizeQueue</code>里放入了东西<code>newEntry</code>。</p><p><img loading="lazy" alt="img" src="/assets/images/20ed0338-3dfe-4fcd-bd56-d09c75229ca7-ef096b83326803ab5f094cf114d3af46.png" width="1864" height="1264" class="img_ev3q"></p><p>所以会直接从 273 行，break 出来，开始执行 <code>289</code>行，将自己的 <code>_willEnsureProcessing</code> 状态改为了 false。</p><p>通过之前提到的父子关系（老父亲带着 3 个儿子），我们继续看 281 行的代码。很显然是可以走进这个条件判断的，继续 debug。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> child </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_children</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_parallelism</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_activeTasks</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PROCESSING_STATE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_startProcessing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">child</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_queued</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>这块代码的主要含义还是，遍历子队列，并取出相关的任务 赋值给 <code>entry</code>变量，如果<code>entry</code> 不存在，说明子队列为空，直接 break，开始遍历下一个子队列。如果子队列有数据，对父级当前进行的任务数量加一（<code>this._activeTasks++;</code>），然后把相关任务的状态改为 <code>PROCESSING_STATE</code>，也就是任务进行中，调用子队列的 <code>_startProcessing</code> 把任务传入。</p></blockquote><p>毫无疑问的是，我们的 <code>factorizeQueue</code> 子队列中存在任务<code>newEntry</code>，继续 debug 验证猜想。 <img loading="lazy" alt="img" src="/assets/images/ebd61930-e6c0-4ba9-a35a-2cd9b37b0bd8-4e1d88333f7e68592a4a44f19f2fd603.png" width="2240" height="1718" class="img_ev3q"></p><p>下一步应该是进入<code>factorize</code> 队列的<code>_startProcessing</code> 方法了（注意队列已经切换了）。继续 debug，</p><p><img loading="lazy" alt="img" src="/assets/images/4b4cdb5b-2909-464c-a29e-e33ed171ef00-dd30c5e911228f78d79d44a64a149f9a.png" width="2182" height="1698" class="img_ev3q"></p><p>注意看，此时的 this 指向 是 <code>factorize</code> 队列。那就继续调试 <code>_startProcessing</code> 方法。</p><p>调试 <code>this.hooks.beforeStart</code> hook,结果如下： <img loading="lazy" alt="img" src="/assets/images/86659d5b-8773-4a39-931d-65ffd4beb005-75076add483d621de7eeab652f32c423.png" width="1772" height="1700" class="img_ev3q"> 还是未绑定任何的插件，继续执行下去。</p><p><img loading="lazy" alt="img" src="/assets/images/bd2ee3b8-eb05-436b-bbec-040a96293eea-f91e3c2243ad45222679208a32b5ad56.png" width="2146" height="1128" class="img_ev3q"></p><p>没有出现 err,直接忽略，开始看 316 行，此处的执行的 <code>this._processor</code>，让我们回顾一下 <code>1.2章节</code> 中的关于 <code>constructor</code> 的部分，核心代码如下图：</p><p><img loading="lazy" alt="img" src="/assets/images/09ddbd29-3bea-4970-9322-2e6175ce4438-cbcdfc3568183b0d95b49f26b91c3715.png" width="2042" height="824" class="img_ev3q"></p><p>这意味着 我们要去看 实例化 <code>factorize</code> 时候传入的 <code>processor</code> 方法是什么？然后去执行它。 回顾 <code>1.2章节</code> 的代码</p><p><img loading="lazy" alt="img" src="/assets/images/f139cf02-5681-4ef9-9835-4618a13cddf6-22364ff2301d22e96bc9bcdd872a49b5.png" width="2092" height="1186" class="img_ev3q"></p><p><code>processor</code> 指的是 <code>compilation</code> 中的 <code>_factorizeModule</code> 方法</p><p><img loading="lazy" alt="img" src="/assets/images/b1957e34-e18e-44cd-a9ca-17a298d06634-cb80d4a2c8095adb3cad46b4f7e5117c.png" width="1778" height="1420" class="img_ev3q"></p><p>断点到 <code>_factorizeModule</code> 上，你会发现其主要执行的是 <code>factory.create</code> 方法，而此时的 <code>factory</code> 是 <code>NormalModuleFactary</code> 的实例，这里本质上也就是去 执行 <code>NormalModuleFactary</code> 类的 <code>create</code> 方法。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-执行-normalmodulefactary-类的-create-方法">2.2 执行 <code>NormalModuleFactary</code> 类的 <code>create</code> 方法<a href="#22-执行-normalmodulefactary-类的-create-方法" class="hash-link" aria-label="22-执行-normalmodulefactary-类的-create-方法的直接链接" title="22-执行-normalmodulefactary-类的-create-方法的直接链接">​</a></h3><p>断点进入该 <code>create</code> 函数，核心代码逻辑如下：</p><p><img loading="lazy" alt="img" src="/assets/images/02f8a8bd-d146-4fe2-aa31-a276c5e7461d-3997989977429f913080b4cc8962204f.png" width="2868" height="1442" class="img_ev3q"></p><p>从<code>742</code> 到 <code>755</code> 行，很明显的都可以看出仅仅是变量的赋值和变量的初始化，而所有的变量都是存在了<code>resolveData</code> 对象里。走一下断点，看一下里面都是什么数据。</p><p><img loading="lazy" alt="img" src="/assets/images/4a67bc71-3dd4-42da-8b9b-99ec28db270b-be02ae3f3ce4d60d1cfc52746f846973.png" width="2346" height="862" class="img_ev3q"></p><p>此处没啥难点，继续向下走，要进入<code>beforeResolve</code>的 hook 里了，直接断点进入，</p><p><img loading="lazy" alt="img" src="/assets/images/47ca6ba4-893c-4060-beff-2d035f3587b2-3e66ad9f7a8ef0a0dc7412e1a88d39c2.png" width="2732" height="1678" class="img_ev3q"> 发现此 hook 也没有被任何插件所监听，那就直接进入此 hook 的 callback 里。</p><p><img loading="lazy" alt="img" src="/assets/images/96284def-7b29-4b87-aa65-a2f6ab8f4926-5066acf61f272a59ff57b1f93b6f5be6.png" width="2516" height="1144" class="img_ev3q"> <code>err 和 result</code> 变量都是<code>undefined</code>，毫无疑问的又进入到了 801 行的 <code>factorize</code> 的 hook 了，那就继续断（慢慢的就会明白 webpack5 插件强大的背后，是难读的设计和调试）。开始调试 <code>NormalModuleFactary</code> 的 <code>factorize</code> 的 hook。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23-调试-normalmodulefactary-的-factorize-的-hook">2.3 调试 <code>NormalModuleFactary</code> 的 <code>factorize</code> 的 hook<a href="#23-调试-normalmodulefactary-的-factorize-的-hook" class="hash-link" aria-label="23-调试-normalmodulefactary-的-factorize-的-hook的直接链接" title="23-调试-normalmodulefactary-的-factorize-的-hook的直接链接">​</a></h3><p>老规矩，首先查看监听此 hook 的插件有哪些，见下图</p><p><img loading="lazy" alt="img" src="/assets/images/8543506e-7771-45a6-b1d8-36f63e69b174-c34e996ac5894c95d1eb733f2d9fb325.png" width="2528" height="1696" class="img_ev3q"></p><p>终于有插件进行监听了（注意此处<code>NormalModuleFactory</code>插件的<code>stage</code>属性），说明这个 hook 还是蛮重要的。继续断点，进入<code>ExternalModuleFactoryPlugin</code>的内部。</p><p><img loading="lazy" alt="img" src="/assets/images/f733954a-3ab7-4301-9592-586b5d74efaa-e1d207aab5620017a86aeaecb630e38d.png" width="2850" height="1652" class="img_ev3q"></p><p>发现此插件的逻辑分为两部分，第一部队是去一步一步解构赋值传入的 <code>resolveData</code> 的数据。（不明白此处作者为啥不使用 es6 的对象解构语法去处理。。。。），然后生命两个函数，最后调用<code>handleExternals</code> 函数，传入 <code>ExternalModuleFactoryPlugin</code>插件 实例的 <code>externals</code> 属性，注意看此处的 <code>externals</code> 属性是 <code>/^(\/\/|https?:\/\/|std:)/</code> （这个正则表达式用于匹配字符串的开头是否以”//“或”http://“或”https://“或”std:“）。</p><blockquote><p>ExternalModuleFactoryPlugin 是 Webpack 的内置插件之一，它的作用是帮助 Webpack 处理外部的模块引入。在使用 Webpack 打包时，如果一个模块需要从外部引入，可以通过设置 externals 属性实现。ExternalModuleFactoryPlugin 插件会通过检查这些外部模块的配置，生成对应的 ExternalModule 对象，在 Webpack 运行过程中当这些模块被请求时，ExternalModuleFactoryPlugin 会负责处理这个请求。</p></blockquote><p>进入<code>handleExternals</code> 函数里，结果如下图：</p><p><img loading="lazy" alt="img" src="/assets/images/cfcfae75-27b2-48c0-815a-10a6255e03a0-c91d28f58975b75e15b7ff3b95b3e92a.png" width="2806" height="1244" class="img_ev3q"> 由于我们的本次的依赖是本地依赖，所以正则匹配失败了，那么结果就是要走到 <code>callback</code> 里了。转了一圈啥也没有做，callback 为空，那就继续断点，向下执行，进入 <code>NormalModuleFactory</code> 插件里。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="24-进入-normalmodulefactory-插件执行factorize-的-hook-核心逻辑">2.4 进入 <code>NormalModuleFactory</code> 插件执行<code>factorize</code> 的 hook 【核心逻辑】<a href="#24-进入-normalmodulefactory-插件执行factorize-的-hook-核心逻辑" class="hash-link" aria-label="24-进入-normalmodulefactory-插件执行factorize-的-hook-核心逻辑的直接链接" title="24-进入-normalmodulefactory-插件执行factorize-的-hook-核心逻辑的直接链接">​</a></h3><p>断点进入：</p><p><img loading="lazy" alt="img" src="/assets/images/7dc8bc4d-471d-4321-b850-b58842724126-931113f31f28dd7e3ac86de5ac97c093.png" width="2096" height="974" class="img_ev3q"> 进入以后你会发现，这个 hook 又触发了 <code>resolve</code> 的 hook，这不就是套娃吗？然后继续断点看监听了<code>resolve</code>的 hook 上都有哪些插件？</p><p><img loading="lazy" alt="img" src="/assets/images/370c0611-ad7e-4c15-949a-9fa28a2a6b02-91453729fd5fefe90caf5307b7feaad9.png" width="2848" height="1670" class="img_ev3q"> 你会发现监听此 hook 的还是这哥们自身，这不是耍我们呢吗？？？？？ 实则不然，他完全可以写的很优雅，但是为了能尽可能的把 hook 给暴露出去，增强 webpack 的定制化能力，不得不这么做。</p><blockquote><p>如果是你，易读和强大的能力你会选择哪个呢？</p></blockquote><p>继续断点下去。</p><p><img loading="lazy" alt="img" src="/assets/images/fa95ccdf-9c95-4348-847d-c604a4402ba3-b20742218d793d9ffe5f47fe9886b6cc.png" width="2108" height="928" class="img_ev3q"> 你会发现此 hook 的逻辑竟然高达 400 行左右的代码，一起去断点看看做了什么吧，我会把某些当前无用的方法过滤掉。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  contextInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 上下文：/Users/fujunkui/Desktop/github-project/webpack/examples/01-base</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dependencies</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dependencyType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 路径是：/Users/fujunkui/Desktop/github-project/webpack/examples/01-base/src/index.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assertions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resolveOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fileDependencies</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  missingDependencies</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  contextDependencies</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> contextScheme </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getScheme</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// undefined</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> scheme </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getScheme</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// undefined</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">scheme</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> requestWithoutMatchResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheme </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getScheme</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestWithoutMatchResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">scheme </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">contextScheme</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> firstChar </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requestWithoutMatchResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">charCodeAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> secondChar </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requestWithoutMatchResource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">charCodeAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;dependencies start with&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noPreAutoLoaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstChar </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">45</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> secondChar </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// startsWith &quot;-!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noAutoLoaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> noPreAutoLoaders </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> firstChar </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// startsWith &quot;!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noPrePostAutoLoaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> firstChar </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> secondChar </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// startsWith &quot;!!&quot;;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> rawElements </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requestWithoutMatchResource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        noPreAutoLoaders </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> noPrePostAutoLoaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> noAutoLoaders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">!+</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unresolvedResource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rawElements</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    elements </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rawElements</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">el</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> query </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cachedParseResourceWithoutFragment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">el</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">loader</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">options</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> query </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheme </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getScheme</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unresolvedResource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">continueCallback</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ....</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">resolveRequestArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contextInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contextScheme </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">context</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    elements</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    loaderResolver</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resolveContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">continueCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      loaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">continueCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scheme</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...条件进不去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contextScheme</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...条件进不去</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">defaultResolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>部分核心代码的运行时的参数截图如下： <img loading="lazy" alt="img" src="/assets/images/ad66211d-bc36-4deb-8598-c2c09ffe045a-935079867f47c74bf99cff30b139908b.png" width="2806" height="1402" class="img_ev3q"> 此处主要是判断 此文件的 request 路径是否以某些行内 loader 的方式进行开头的。 <a href="https://webpack.js.org/concepts/loaders/#inline" target="_blank" rel="noopener noreferrer">详情见官网</a></p><p><img loading="lazy" alt="img" src="/assets/images/cc256643-6aa9-4955-b851-e29caa3f0321-0bb7ec7b91f5f3a7a3f2d3fcc537fece.png" width="2308" height="1398" class="img_ev3q"></p><p><code>resolveRequestArray</code>是必须要执行的，此处附上相关的运行结果</p><p><img loading="lazy" alt="img" src="/assets/images/d1092159-0a42-408d-94ee-44e3326f1d8b-62d2b185a99a39d8593308ecd808a20f.png" width="2344" height="1340" class="img_ev3q"></p><p>最后走进了 <code>defaultResolve(context)</code> 里。进入 此函数看执行过程。</p><p><img loading="lazy" alt="img" src="/assets/images/584bce05-3ec5-4e51-9cc4-0680c49a87a6-8e7bd1c5c4aae1724e5c0ff902fcfefe.png" width="2760" height="1544" class="img_ev3q"></p><p>最后进入<code>resolveResource</code>函数里，断点进入。</p><p><img loading="lazy" alt="img" src="/assets/images/d618d248-9975-4ef4-813b-fcf8ed0643cf-4f4ba1e58842f51b0bdcdcd0609c8f06.png" width="2830" height="1214" class="img_ev3q"></p><p>调用<code>resolver.resolve</code>的方法，获取到 <code>unresolvedResource</code> 的真实路径。</p><blockquote><p>关于此处，如果你不了解 <code>resolver.resolve</code>的方法的原理，可以去看我前面的文章，<code>【webpack核心库】耗时7个小时，用近50张图来学习enhance-resolve中的数据流动和插件调度机制</code>，可以搜索一下上面的标题，也是干货满满。</p></blockquote><p>继续断点，走到 callback 接受 <code>resolve</code> 处理以后的结果如下图。 <img loading="lazy" alt="img" src="/assets/images/5615cf0e-be36-4bc2-9c20-aa317d51615a-d80f22f76566acdc12a1b98e112be188.png" width="2840" height="1708" class="img_ev3q"></p><p>进入 callback 里。</p><p><img loading="lazy" alt="img" src="/assets/images/5346c5d3-b443-4318-804f-7644a8196df4-4c145a4402e948467e7c879246ceeb08.png" width="2854" height="1750" class="img_ev3q"></p><p>发现最后走到了 <code>continueCallback</code> 函数里。</p><p><img loading="lazy" alt="img" src="/assets/images/d282871c-7be1-43dc-9ef5-27438840b763-8f17a723cf2bb9e7cb4ca4c1103f0357.png" width="2346" height="1446" class="img_ev3q"></p><p>关于此函数，内容有些多，此处就不做进行解析了。直接断点回到刚刚的 <code>this.hooks.resolve.callAsync</code>的部分。在其 <code>callback</code> 内部打上断点。</p><p><img loading="lazy" alt="img" src="/assets/images/a393fe43-937b-47e2-aaff-26193d908410-7d1fdc3ec8bc681c4f269c1db8d22b65.png" width="2778" height="1698" class="img_ev3q"> 这样就可以跳过<code>continueCallback</code>的部分，</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="25-进入-resolve-hook-的内部">2.5 进入 <code>resolve</code> hook 的内部<a href="#25-进入-resolve-hook-的内部" class="hash-link" aria-label="25-进入-resolve-hook-的内部的直接链接" title="25-进入-resolve-hook-的内部的直接链接">​</a></h3><p>继续断点</p><p><img loading="lazy" alt="img" src="/assets/images/40f49418-526a-4fb2-9f1b-fee3933a216d-1d4024cc29776384466574840844b1a0.png" width="2682" height="1510" class="img_ev3q"></p><p>因为 <code>err 和 result</code>都为空，最后走到了<code>afterResolve</code>的 hook 里。 大家都应该会调试了，直接说结果了，没有插件去监听<code>afterResolve</code>的 hook，所以直接进其内部了。</p><p><img loading="lazy" alt="img" src="/assets/images/ce1d2f9e-cd1c-42bf-8f4b-a949b03498d5-f8c93261203cae8140ed280210bc9eec.png" width="2844" height="1740" class="img_ev3q"></p><p>进入此 hook 内部以后，又是一堆的错误判断，最后走进了 <code>createModule</code> 的 hook。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="26-进入-createmodule-的-hook-将路径等信息变为-module">2.6 进入 <code>createModule</code> 的 hook 【将路径等信息变为 Module】<a href="#26-进入-createmodule-的-hook-将路径等信息变为-module" class="hash-link" aria-label="26-进入-createmodule-的-hook-将路径等信息变为-module的直接链接" title="26-进入-createmodule-的-hook-将路径等信息变为-module的直接链接">​</a></h3><p>此 hook 还是无插件监听，直接上图看其 callback 做了啥：</p><p><img loading="lazy" alt="img" src="/assets/images/8ca42e9e-3de6-488f-9e29-d66849758576-fd6920fed716a9249f02cd1b54de1e65.png" width="2776" height="1726" class="img_ev3q"></p><p>此处对整体的 webpack 来说是比较核心的，将路径代表的文件给变成了模块化的<code>Module</code>对象。（读者可以好好理解其背后的含义）</p><p>至于 Module 对象 不是本章的重点，这里只需要明白 <code>路径代表的文件变为了 Module对象</code> 即可。 然后继续向下执行，调用 <code>module</code>的 hook。直接看注册此 hook 的<code>SideEffectsFlagPlugin</code>插件。</p><blockquote><p>Webpack 5 中的 SideEffectsFlagPlugin 主要用于优化项目的构建速度和代码体积。它能够在打包时根据配置文件中的 &quot;sideEffects&quot; 属性，自动确定哪些模块是有副作用的（即会对全局状态产生影响），哪些模块是纯粹的（即不会对全局状态产生影响）。当一个模块被判断为无副作用时，Webpack 5 会将其标记为 &quot;side-effect-free&quot;，这样就可以进行一系列优化操作，如 tree shaking、scope hoisting 等，以减小最终打包出来的代码体积和提高加载速度。因此，通过合理配置 &quot;sideEffects&quot; 属性，并使用 SideEffectsFlagPlugin 插件，可以帮助开发者更好地优化自己的 Webpack 5 项目。</p></blockquote><p><img loading="lazy" alt="img" src="/assets/images/e8d753c8-f9be-44b9-92c5-2de73d227c8a-fe9f754c6d4fa8544e73a3e9893cbac6.png" width="2308" height="1690" class="img_ev3q"></p><p>此插件里注册了两个监听函数。其执行结果如下：</p><p><img loading="lazy" alt="img" src="/assets/images/631ab891-6bcd-44c8-8103-528c8b21b952-dba370eb49b88d1a8dd86075ff2b96dc.png" width="2228" height="1204" class="img_ev3q"></p><p><img loading="lazy" alt="img" src="/assets/images/8c7f37e9-6f09-41e3-a472-502ef3999a53-8bfbeb6cf6b26ec407fd8231feba8f68.png" width="2146" height="1148" class="img_ev3q"></p><p>执行完毕，将根据路径创建的 module 实例通过 callback 传递出去。继续单步断点，看此 callback 会走进哪个 hook 里。</p><p><img loading="lazy" alt="img" src="/assets/images/fb874503-4bf9-4a37-a22c-02b5c3505712-5d223a65ae78c409d74fefe41958dc29.png" width="2242" height="1204" class="img_ev3q"></p><p>最后走进了 <code>factorize</code> 的 hook，</p><p>至此，实现了一个 文件变成了一个 Module 的过程。继续向下执行 callback，看下一步是做什么？</p><p><img loading="lazy" alt="img" src="/assets/images/4cc7a3ec-e88f-42fc-b241-5253e349320a-84c4c3880e4c0f9481b92d10668feadb.png" width="2288" height="1632" class="img_ev3q"></p><p>走到了 <code>factory.create</code> 的 callback 函数了，也就是 <code>_factorizeModule</code>方法。还记得这个方法是哪个队列的 <code>processor</code>方法吗？ 贴上代码：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">factorizeQueue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AsyncQueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;factorize&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">parent</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">addModuleQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token literal-property property" style="color:#36acaa">processor</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">_factorizeModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">bind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>让我们继续执行下去，</p><p><img loading="lazy" alt="img" src="/assets/images/76c3c672-2f31-4ef2-8102-0d9a8ce1e826-3fa8181428314d2bfb3e4a1984c17b99.png" width="2310" height="1714" class="img_ev3q"> 执行到 <code>callback</code> 里的 <code>callback</code>，继续进入此 <code>callback</code>（链路太长了，绕来绕去的）</p><p>进入到 <code>AsyncQueue.js</code>文件。</p><p><img loading="lazy" alt="img" src="/assets/images/bc9f6d86-faa4-4a6a-8eb3-db9ab7caa18a-22b1b643f7e04b41442a5a2ce0b86607.png" width="1972" height="1202" class="img_ev3q"> 再调用 <code>_handleResult</code> 去处理<code>_processor</code>后的结果。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="27-进入-_handleresult-方法">2.7 进入 <code>_handleResult</code> 方法<a href="#27-进入-_handleresult-方法" class="hash-link" aria-label="27-进入-_handleresult-方法的直接链接" title="27-进入-_handleresult-方法的直接链接">​</a></h3><p>上图：</p><p><img loading="lazy" alt="img" src="/assets/images/7a94ae8e-be8d-4b87-8a60-491962f4b8ca-7039390ac60237df6c79ba927b801b26.png" width="2190" height="1610" class="img_ev3q"></p><p>这个方法比较简单，直接调用了 <code>result</code> 的 hook，此 hook 也没有插件进行监听，直接执行自身的 callback 函数，进入 此 hook 的内部。</p><p><img loading="lazy" alt="img" src="/assets/images/f54426b8-9839-47a1-8c7c-8ea295e9fadb-9131b9f63d9ec2c9a76934cf369fc4df.png" width="2212" height="1728" class="img_ev3q"></p><p>红色圈中部分，将队列子项<code>AsyncQueueEntry</code>的状态改为完成的状态。然后找到父级，将父级用于计数当前激活任务的值减一。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 如果父级用有需要进行的任务并且父级需要去执行。就把相关任务添加进异步里。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_willEnsureProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_needProcessing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_willEnsureProcessing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setImmediate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">_ensureProcessing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当前父级不需要执行什么任务，此处跳过。继续向下执行。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inHandleResult</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">nextTick</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callbacks </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> callback </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> callbacks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callbacks </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token keyword nil" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> callback </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> callbacks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此时的 <code>inHandleResult</code> 判断没有走进 if 分支，走到 else 分支。这里你会发现不管走进那个条件里，核心代码都是一样的，唯一的区别在于是否包裹在<code>process.nextTick</code>里。</p><p>继续调试下去，执行<code>callback(error, result);</code>，此处的 <code>callback</code>是从 <code>AsyncQueueEntry</code>身上取到的。回想一下这里的 <code>callback</code>的来源是哪里？</p><p><img loading="lazy" alt="img" src="/assets/images/6abaf686-73df-43ee-9d6e-77f96302bdfb-3277a58a5b7f2181c1a90361b59ad5a1.png" width="2076" height="1230" class="img_ev3q"></p><p>是<code>AsyncQueue</code> 调用<code>add</code>时候传入的 <code>callback</code> 函数。</p><p><img loading="lazy" alt="img" src="/assets/images/b247d8b9-4cb8-4bd3-a0b8-b8d35d492984-1e79bd8448de6b2a75a7e4eba0c5a8a8.png" width="2164" height="1016" class="img_ev3q"></p><p>回想一下调用这个方法的位置：</p><p><img loading="lazy" alt="img" src="/assets/images/a811482d-1375-4690-936f-dab7634dee32-43b36ee63e26f6c8d9331750976b952c.png" width="2216" height="1502" class="img_ev3q"></p><p>兜兜转转的，又回到了 <code>Compilation.js</code> 这个文件。继续调试，大概率是要进入 <code>addModule</code>这个方法的。</p><p><img loading="lazy" alt="img" src="/assets/images/44c3cecb-a9e9-454d-b73d-c35d3f82e462-ec930870a83e3abe13d14661839c1aff.png" width="2244" height="1302" class="img_ev3q"></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">addModule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">module</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">addModuleQueue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">module</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到这个代码，感觉是不是有些相似，又回到了本文（梦）开始的地方。</p><p>关于<code>addModuleQueue.add</code>后，接下来的路，各位读者，还需要我再出一篇文章去解析吗？有需要的读者，<code>可以在评论区评论告诉我哈</code>。毕竟每个 <code>AsyncQueue</code> 里的具体执行内容不一样。</p><p><img loading="lazy" alt="img" src="/assets/images/wMhpCUOi07clNfoAFTP1S7Jj0xoU3Q9C-b8faba1e6b3c4b73dcbef942034c8851.gif" width="270" height="270" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/webpack/tags/js">js</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/webpack/tags/webpack">webpack</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/fu1996/fu1996.github.io/tree/main/webpack/webpack5源码解析/05-webpack5中的事件调度系统和NormalModuleFactary核心逻辑.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>fjk</b> <!-- -->于 <b><time datetime="2023-09-17T16:09:09.000Z">2023年9月17日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/webpack/webpack5源码解析/浅析webpack5中Compiler中重要的hook调用过程"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">04-浅析webpack5中Compiler中重要的hook调用过程</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/webpack/webpack5源码解析/webpack5的loader-runner源码浅析"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">06-webpack5的loader-runner源码浅析</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-书接上回从-thisfactorizequeueaddoptions-callback-开始" class="table-of-contents__link toc-highlight">1. 书接上回，从 <code>this.factorizeQueue.add(options, callback);</code> 开始</a><ul><li><a href="#11-通过-factorizequeue-了解-asyncqueue" class="table-of-contents__link toc-highlight">1.1 通过 factorizeQueue 了解 AsyncQueue</a></li><li><a href="#12-深入-asyncqueue-中的-add-方法" class="table-of-contents__link toc-highlight">1.2 深入 <code>AsyncQueue</code> 中的 <code>add</code> 方法</a></li><li><a href="#13-浅浅的总结一下" class="table-of-contents__link toc-highlight">1.3 浅浅的总结一下~</a></li></ul></li><li><a href="#2-异步队列要开始了" class="table-of-contents__link toc-highlight">2. 异步队列要开始了</a><ul><li><a href="#21-执行-processdependencies-队列的-_ensureprocessing-方法" class="table-of-contents__link toc-highlight">2.1 执行 <code>processDependencies</code> 队列的 <code>_ensureProcessing</code> 方法</a></li><li><a href="#22-执行-normalmodulefactary-类的-create-方法" class="table-of-contents__link toc-highlight">2.2 执行 <code>NormalModuleFactary</code> 类的 <code>create</code> 方法</a></li><li><a href="#23-调试-normalmodulefactary-的-factorize-的-hook" class="table-of-contents__link toc-highlight">2.3 调试 <code>NormalModuleFactary</code> 的 <code>factorize</code> 的 hook</a></li><li><a href="#24-进入-normalmodulefactory-插件执行factorize-的-hook-核心逻辑" class="table-of-contents__link toc-highlight">2.4 进入 <code>NormalModuleFactory</code> 插件执行<code>factorize</code> 的 hook 【核心逻辑】</a></li><li><a href="#25-进入-resolve-hook-的内部" class="table-of-contents__link toc-highlight">2.5 进入 <code>resolve</code> hook 的内部</a></li><li><a href="#26-进入-createmodule-的-hook-将路径等信息变为-module" class="table-of-contents__link toc-highlight">2.6 进入 <code>createModule</code> 的 hook 【将路径等信息变为 Module】</a></li><li><a href="#27-进入-_handleresult-方法" class="table-of-contents__link toc-highlight">2.7 进入 <code>_handleResult</code> 方法</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.526452a3.js"></script>
<script src="/assets/js/main.9718d5f0.js"></script>
</body>
</html>